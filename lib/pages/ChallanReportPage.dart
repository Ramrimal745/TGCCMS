import 'package:flutter/material.dart';import 'package:get/get.dart';import 'package:tcs_demo/components/SubReportCard.dart';import 'package:tcs_demo/requestModels/ChallanRequest.dart';import 'package:tcs_demo/responseModels/ChallanResponse.dart';import 'package:tcs_demo/viewModels/ReportViewModel.dart';import '../components/ChallanDisplayDialog.dart';import '../components/CustomTextField.dart';import '../components/ViewTransactionDetailsDialog.dart';import '../components/bottomsheet.dart';import '../viewModels/ChallanViewModel.dart';class ChallanReportPage extends StatefulWidget {  const ChallanReportPage({super.key});  @override  State<ChallanReportPage> createState() => _ChallanReportPageState();}class _ChallanReportPageState extends State<ChallanReportPage> {  final reportViewModel = Get.put(ReportViewModel());  String selectedStatus = '';  String searchKey = '';  @override  void initState() {    super.initState();    reportViewModel.fetchChallanReport(ChallanReportRequest(        loginId: '301985',        fromDate: "",        toDate: "",        challanOrMobileOrTradeID: ''));  }  @override  Widget build(BuildContext context) {    return Scaffold(      appBar: AppBar(        backgroundColor: Colors.blueAccent,        title: const Text(          'MIS',          style: TextStyle(              color: Colors.white, fontWeight: FontWeight.w600, fontSize: 16),        ),        leading: IconButton(          icon: const Icon(Icons.arrow_back, color: Colors.white),          onPressed: () {            Navigator.pop(context);          },        ),      ),      body: Obx(() {        final reportList = reportViewModel.challanReportResponseState.value            .whenOrNull(success: (data) => data as ChallanReportResponse?)            ?.challans            ?.where((item) =>        item.challanNumber?.toLowerCase().contains(searchKey) == true ||            item.challanDate?.toLowerCase().contains(searchKey) == true ||            item.offence?.toLowerCase().contains(searchKey) == true ||            item.offenceHolderName?.toLowerCase().contains(searchKey) == true ||            item.amount?.toString().toLowerCase().contains(searchKey) == true        ).where((item) =>        selectedStatus == ''            ? true            : selectedStatus == 'Paid'            ? item.paymentStatus == '1'            : item.paymentStatus == '0')            .toList();        final reportLength = reportList?.length ?? 0;        return SingleChildScrollView(            padding: const EdgeInsets.all(12),            child: Column(              children: [                Container(                  decoration: BoxDecoration(                    color: Colors.blue,                    borderRadius: BorderRadius.circular(8),                  ),                  child: Column(                    children: [                      const SizedBox(height: 10),                      const Text(                        "Challan Details",                        style: TextStyle(                          color: Colors.white,                          fontWeight: FontWeight.w600,                          fontSize: 14,                        ),                      ),                      reportViewModel.challanReportResponseState.value                          .whenOrNull(loading: () => true) ==                          true                          ? const Padding(                        padding: EdgeInsets.all(8.0),                        child: Align(                          alignment: Alignment.center,                          child: CircularProgressIndicator(                              color: Colors.white),                        ),                      )                          : Container(                        margin: const EdgeInsets.all(4),                        color: Colors.white,                        child: Column(                          children: [                            Padding(                              padding: const EdgeInsets.symmetric(                                  horizontal: 12.0, vertical: 12),                              child: CustomTextField(                                label: 'Search by Challan No. / Name',                                onChange: (inputValue){                                  setState(() {                                    searchKey = inputValue.toLowerCase();                                  });                                },                              ),                            ),                            Row(                              mainAxisAlignment: MainAxisAlignment.center,                              // Aligns the row in the center                              children: [                                RadioMenuButton(                                  value: '',                                  groupValue: selectedStatus,                                  onChanged: (String? value) {                                    setState(() {                                      selectedStatus = '';                                    });                                  },                                  child: const Text("All"),                                ),                                RadioMenuButton(                                  value: 'Paid',                                  groupValue: selectedStatus,                                  onChanged: (String? value) {                                    setState(() {                                      selectedStatus = 'Paid';                                    });                                  },                                  child: const Text("Paid"),                                ),                                RadioMenuButton(                                  value: 'Pending',                                  groupValue: selectedStatus,                                  onChanged: (String? value) {                                    setState(() {                                      selectedStatus = 'Pending';                                    });                                  },                                  child: const Text("Pending"),                                ),                              ],                            ),                            Container(                              height: MediaQuery                                  .of(context)                                  .size                                  .height -                                  290,                              color: Colors.grey.withOpacity(0.15),                              padding: const EdgeInsets.only(top: 8),                              child: ListView.builder(                                primary: false,                                scrollDirection: Axis.vertical,                                physics: const BouncingScrollPhysics(),                                itemCount: reportLength,                                itemBuilder: (context, index) {                                  final item = reportList?[index];                                  return Card(                                    shape: RoundedRectangleBorder(                                      borderRadius:                                      BorderRadius.circular(6),                                    ),                                    color: Colors.white,                                    margin: const EdgeInsets.symmetric(                                        horizontal: 12, vertical: 4),                                    child: Column(                                      mainAxisAlignment:                                      MainAxisAlignment.start,                                      children: [                                        Padding(                                          padding:                                          const EdgeInsets.all(10.0),                                          child: Column(                                            mainAxisSize:                                            MainAxisSize.max,                                            crossAxisAlignment:                                            CrossAxisAlignment.start,                                            mainAxisAlignment:                                            MainAxisAlignment.start,                                            children: [                                              SubReportCard(                                                  title: 'Challan Number',                                                  value:                                                  item?.challanNumber ??                                                      ""),                                              Container(                                                height: 1,                                                width: double.infinity,                                                color: Colors.grey,                                                margin: const EdgeInsets                                                    .symmetric(                                                    vertical: 4),                                              ),                                              SubReportCard(                                                  title: 'Challan Date',                                                  value:                                                  item?.challanDate ??                                                      ""),                                              Container(                                                height: 1,                                                width: double.infinity,                                                color: Colors.grey,                                                margin: const EdgeInsets                                                    .symmetric(                                                    vertical: 4),                                              ),                                              SubReportCard(                                                  title: 'Component',                                                  value: item?.offence ??                                                      ""),                                              Container(                                                height: 1,                                                width: double.infinity,                                                color: Colors.grey,                                                margin: const EdgeInsets                                                    .symmetric(                                                    vertical: 4),                                              ),                                              SubReportCard(                                                  title: 'Name',                                                  value:                                                  item?.offenceHolderName ??                                                      ""),                                              Container(                                                height: 1,                                                width: double.infinity,                                                color: Colors.grey,                                                margin: const EdgeInsets                                                    .symmetric(                                                    vertical: 4),                                              ),                                              SubReportCard(                                                  title: 'Charges',                                                  valueColor: Colors.red,                                                  value: item?.amount                                                      ?.toString() ??                                                      ""),                                              Container(                                                height: 1,                                                width: double.infinity,                                                color: Colors.grey,                                                margin: const EdgeInsets                                                    .symmetric(                                                    vertical: 4),                                              ),                                              SizedBox(                                                width: double.infinity,                                                child: Row(                                                  mainAxisAlignment:                                                  MainAxisAlignment                                                      .spaceBetween,                                                  children: [                                                    Text(                                                      item?.paymentStatus ==                                                          "0"                                                          ? "Pending"                                                          : "Paid",                                                      style: TextStyle(                                                          fontWeight:                                                          FontWeight                                                              .bold,                                                          color: item                                                              ?.paymentStatus ==                                                              '0'                                                              ? Colors.red                                                              : Colors                                                              .green),                                                    ),                                                    GestureDetector(                                                        onTap: () {                                                          Get.dialog(                                                              ChallanDisplayDialog(                                                                data: {                                                                  'Challan No':                                                                  item                                                                      ?.challanNumber ??                                                                      "",                                                                  'Challan Date':                                                                  item                                                                      ?.challanDate ??                                                                      "",                                                                  'Offender Type': item                                                                      ?.offenceHolderType ??                                                                      "",                                                                  'Name': item                                                                      ?.offenceHolderName ??                                                                      "",                                                                  'Address': item                                                                      ?.address ??                                                                      "",                                                                  'Mobile Number': item                                                                      ?.mobileNumber ??                                                                      "",                                                                  'Violation': item                                                                      ?.offence ??                                                                      '',                                                                  'Penality Amount (Rs.)': item                                                                      ?.amount                                                                      ?.toString() ??                                                                      "",                                                                  'Payment Status': item                                                                      ?.paymentStatus ??                                                                      "",                                                                  'Photo of Violation': item                                                                      ?.offencePhotoPath ??                                                                      "",                                                                  'Location Details of Violation':                                                                  'Lat: ${item                                                                      ?.latitude ??                                                                      ""} Long: ${item                                                                      ?.longitude ??                                                                      ""}',                                                                },                                                                challanNumber: item                                                                    ?.challanNumber ??                                                                    "",                                                                closeTimes: 0,                                                                successCloseTimes: 2,                                                              ));                                                        },                                                        child: const Text(                                                          "More Details",                                                          style:                                                          TextStyle(                                                            color: Colors                                                                .blueAccent,                                                            fontSize: 13,                                                            decoration:                                                            TextDecoration                                                                .underline,                                                            fontWeight:                                                            FontWeight                                                                .bold,                                                          ),                                                        )),                                                  ],                                                ),                                              )                                            ],                                          ),                                        ),                                        Padding(                                          padding:                                          const EdgeInsets.all(10.0),                                          child: Column(                                            mainAxisSize:                                            MainAxisSize.max,                                            crossAxisAlignment:                                            CrossAxisAlignment.center,                                            mainAxisAlignment:                                            MainAxisAlignment.center,                                            children: [                                              GestureDetector(                                                onTap: () {                                                  Get.dialog(ViewTransactionDetailsDialog(                                                    data: {                                                      'Challan No': item?.challanNumber ?? "",                                                      'Challan Date': item?.challanDate ?? "",                                                      'Payment Status': item?.paymentStatus ?? "",                                                    },                                                    challanNumber: item?.challanNumber ?? "", // ✅ pass non-null                                                  ));                                                },                                                child: const Text(                                                  "view Transaction Details",                                                  style: TextStyle(                                                    color: Colors.blueAccent,                                                    fontSize: 13,                                                    decoration: TextDecoration.underline,                                                    fontWeight: FontWeight.bold,                                                  ),                                                ),                                              ),                                              SizedBox(                                                width: double.infinity,                                              )                                            ],                                          ),                                        ),                                      ],                                    ),                                  );                                },                              ),                            ),                          ],                        ),                      )                    ],                  ),                )              ],            ));      }),    );  }}