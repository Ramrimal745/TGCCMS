import 'package:flutter/material.dart';import 'package:get/get.dart';import 'package:pin_code_fields/pin_code_fields.dart';import 'package:tcs_demo/extensions/snackBarExtension.dart';import 'package:tcs_demo/responseModels/EmployeeDetailResponse.dart';import 'package:tcs_demo/viewModels/AuthViewModel.dart';class OtpPage extends StatefulWidget {  bool showMPin;  OtpPage({super.key, required this.showMPin});  @override  State<OtpPage> createState() => _OtpPageState();}class _OtpPageState extends State<OtpPage> {  final authViewModel = Get.put(AuthViewModel());  final _controller = TextEditingController();  final mPinController = TextEditingController();  final mPinConfirmController = TextEditingController();  @override  Widget build(BuildContext context) {    return SafeArea(       top: true,        child: Scaffold(          resizeToAvoidBottomInset: true,          // resizeToAvoidBottomInset: widget.showMPin,          appBar: widget.showMPin              ? AppBar(            backgroundColor: Colors.blueAccent,            title: const Text(              'Create M-Pin',              style: TextStyle(                  color: Colors.white,                  fontWeight: FontWeight.w600,                  fontSize: 16),            ),            leading: IconButton(              icon: const Icon(Icons.arrow_back, color: Colors.white),              onPressed: () {                Navigator.pop(context);              },            ),          )              : null,          body: Stack(            children: [              Visibility(                  visible: widget.showMPin == true,                  child: Container(                    decoration: const BoxDecoration(                      image: DecorationImage(                        image: AssetImage('assets/images/ccms_bg.png'),                        fit: BoxFit.fill,                      ),                    ),                  )),              SingleChildScrollView(                    child: Padding(                      padding: const EdgeInsets.all(20.0),                      child: Column(                        children: [                          Visibility(                              visible: widget.showMPin != true,                              child: Align(                                  alignment: Alignment.centerRight,                                  child: Padding(                                      padding: const EdgeInsets.all(4),                                      child: InkWell(                                          onTap: () => Get.back(),                                          child: const Icon(Icons.close))))),                          Card(                              shadowColor: Colors.black26,                              elevation: 120,                              child: Container(                                decoration: const BoxDecoration(                                    borderRadius:                                    BorderRadius.all(Radius.circular(12)),                                    color: Colors.white),                                child: Padding(                                  padding: const EdgeInsets.symmetric(                                      horizontal: 20.0, vertical: 12),                                  child: Obx(() {                                    final employeeData = authViewModel                                        .employeeDetailResponseState.value                                        .whenOrNull(                                        success: (data) =>                                        data as EmployeeDetailResponse?)                                        ?.employeeDetails;                                    final verifyState =                                        authViewModel.verifyDetailResponseState                                            .value;                                    return Column(                                      mainAxisSize: MainAxisSize.min,                                      mainAxisAlignment: MainAxisAlignment.center,                                      children: [                                        Text(                                          employeeData?.loginId ?? '',                                          style: const TextStyle(                                              color: Colors.blueAccent,                                              fontWeight: FontWeight.bold),                                        ),                                        Text(                                          employeeData?.employeeName ?? '',                                          style: const TextStyle(                                              color: Colors.blueAccent,                                              fontWeight: FontWeight.bold),                                        ),                                        Text(                                          employeeData?.designation ?? '',                                          style: const TextStyle(                                              color: Colors.blueAccent,                                              fontWeight: FontWeight.w500),                                        ),                                        const SizedBox(                                          height: 6,                                        ),                                        Text(                                          'OTP sent to this Mobile No. ******${employeeData                                              ?.mobileNumber?.substring(6, 10)}',                                          style:                                          const TextStyle(color: Colors.black87),                                        ),                                        const SizedBox(                                          height: 12,                                        ),                                        const Text(                                          'Enter OTP',                                          style: TextStyle(                                            color: Colors.black87,                                            fontWeight: FontWeight.w500,                                          ),                                        ),                                        const SizedBox(                                          height: 14,                                        ),                                        SizedBox(                                            width: 200,                                            child: PinCodeTextField(                                              controller: _controller,                                              keyboardType: TextInputType.number,                                              length: 4,                                              appContext: context,                                              pinTheme: PinTheme(                                                  borderRadius:                                                  BorderRadius.circular(4),                                                  borderWidth: 0.5,                                                  fieldHeight: 42,                                                  shape: PinCodeFieldShape.box,                                                  activeColor: Colors.blue,                                                  inactiveColor: Colors.grey),                                            )),                                        const SizedBox(height: 8),                                        SizedBox(                                            width: double.infinity,                                            child: GestureDetector(                                                onTap: () {                                                  Get.back();                                                  authViewModel                                                      .fetchEmployeeDetails(                                                      employeeData                                                          ?.mobileNumber ?? "",                                                      forceMPin: widget.showMPin);                                                },                                                child: const Text(                                                  'Resend OTP?',                                                  textAlign: TextAlign.end,                                                  style: TextStyle(                                                      color: Colors.blue,                                                      fontWeight: FontWeight.w600,                                                      decoration:                                                      TextDecoration.underline),                                                ))),                                        const SizedBox(height: 8),                                        Visibility(                                            visible: (verifyState.whenOrNull(                                                error: (err) => err) ??                                                '')                                                .isNotEmpty ==                                                true,                                            child: Text(                                              verifyState.whenOrNull(                                                  error: (err) => err) ??                                                  '',                                              style:                                              const TextStyle(color: Colors.red),                                            )),                                        const SizedBox(height: 8),                                        const SizedBox(                                          height: 12,                                        ),                                      ],                                    );                                  }),                                ),                              )),                          const SizedBox(height: 20),                          Visibility(                            visible: widget.showMPin,                            child: Card(                                shadowColor: Colors.black26,                                elevation: 120,                                child: Container(                                  width: double.infinity,                                  decoration: const BoxDecoration(                                      borderRadius:                                      BorderRadius.all(Radius.circular(12)),                                      color: Colors.white),                                  child: Padding(                                    padding: const EdgeInsets.symmetric(                                        horizontal: 20.0, vertical: 12),                                    child: Obx(() {                                      final verifyState = authViewModel                                          .verifyDetailResponseState.value;                                      return Column(                                        mainAxisSize: MainAxisSize.min,                                        mainAxisAlignment: MainAxisAlignment                                            .center,                                        children: [                                          const Text(                                            'Create M-Pin',                                            style: TextStyle(                                                color: Colors.blueAccent,                                                fontSize: 16,                                                fontWeight: FontWeight.bold),                                          ),                                          const SizedBox(height: 6),                                          const Text(                                            'Enter M-Pin',                                            style: TextStyle(                                                color: Colors.black87,                                                fontWeight: FontWeight.w500),                                          ),                                          const SizedBox(height: 12),                                          SizedBox(                                              width: 200,                                              child: PinCodeTextField(                                                controller: mPinController,                                                keyboardType: TextInputType                                                    .number,                                                length: 4,                                                appContext: context,                                                pinTheme: PinTheme(                                                    borderRadius:                                                    BorderRadius.circular(4),                                                    borderWidth: 0.5,                                                    fieldHeight: 42,                                                    shape: PinCodeFieldShape.box,                                                    activeColor: Colors.blue,                                                    inactiveColor: Colors.grey),                                              )),                                          const Text(                                            'Confirm M-Pin',                                            style: TextStyle(                                                color: Colors.black87,                                                fontWeight: FontWeight.w500),                                          ),                                          const SizedBox(height: 4),                                          SizedBox(                                              width: 200,                                              child: PinCodeTextField(                                                controller: mPinConfirmController,                                                keyboardType: TextInputType                                                    .number,                                                length: 4,                                                appContext: context,                                                pinTheme: PinTheme(                                                    borderRadius:                                                    BorderRadius.circular(4),                                                    borderWidth: 0.5,                                                    fieldHeight: 42,                                                    shape: PinCodeFieldShape.box,                                                    activeColor: Colors.blue,                                                    inactiveColor: Colors.grey),                                              )),                                          const SizedBox(                                            height: 12,                                          ),                                        ],                                      );                                    }),                                  ),                                )),                          ),                          Obx(() {                            final verifyState =                                authViewModel.verifyDetailResponseState.value;                            return verifyState.maybeWhen(                                loading: () =>                                const CircularProgressIndicator(                                  color: Colors.blueAccent,                                ),                                orElse: () =>                                    FilledButton(                                      style: FilledButton.styleFrom(                                        backgroundColor: Colors.blue,                                        shape: RoundedRectangleBorder(                                          borderRadius: BorderRadius.circular(8),                                        ),                                        padding: const EdgeInsets.symmetric(                                            vertical: 8), // Adjust padding for height                                      ),                                      onPressed: () {                                        if (_controller.text.length < 4) {                                          Get.showSnackBar(                                              message: 'Please Enter OTP');                                          return;                                        }                                        if (widget.showMPin) {                                          if (mPinController.text.isEmpty ||                                              mPinConfirmController.text                                                  .isEmpty) {                                            Get.showSnackBar(                                                message: 'Please Enter MPIN');                                            return;                                          } else if (mPinController.text !=                                              mPinConfirmController.text) {                                            Get.showSnackBar(                                                message:                                                'MPin And Confirm MPin Should be same');                                            return;                                          }                                        }                                        FocusScope.of(context).unfocus();                                        final employeeData = authViewModel                                            .employeeDetailResponseState.value                                            .whenOrNull(                                            success: (data) =>                                            data as EmployeeDetailResponse?)                                            ?.employeeDetails;                                        authViewModel.verifyOTP(                                            _controller.text,                                            widget.showMPin                                                ? mPinConfirmController.text                                                : (employeeData?.mpin ?? ""));                                      },                                      child: const SizedBox(                                          width: double.infinity,                                          child: Text(                                            'Submit',                                            textAlign: TextAlign.center,                                          )),                                    ));                          })                        ],                      ),                    )),            ],          ),        ));    } }